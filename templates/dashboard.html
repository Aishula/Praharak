{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
  <link href="{% static 'main.css' %}" rel="stylesheet">
  <style>
    .card {
      margin-bottom: 20px;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="row">
    <!-- Table Section -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">Log Sources</div>
        <div class="card-body">
          <table class="table table-striped" id="logTable">
            <thead>
              <tr>
                <th>Source</th>
                <th>IP</th>
                <th>Protocol</th>
                <th>Remarks</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Firewall</td>
                <td>192.168.1.1</td>
                <td>TCP</td>
                <td>Normal</td>
              </tr>
              <tr>
                <td>Router</td>
                <td>192.168.1.2</td>
                <td>UDP</td>
                <td>Suspicious</td>
              </tr>
              <tr>
                <td>Switch</td>
                <td>192.168.1.3</td>
                <td>TCP</td>
                <td>Normal</td>
              </tr>
              <tr>
                <td>Server</td>
                <td>192.168.1.4</td>
                <td>UDP</td>
                <td>Critical</td>
              </tr>
              <tr>
                <td>Workstation</td>
                <td>192.168.1.5</td>
                <td>TCP</td>
                <td>Normal</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Bar Chart Section -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">Attack vs Normal Data</div>
        <div class="card-body">
          <canvas id="attackNormalChart"></canvas>
        </div>
      </div>
    </div>
  </div> <!-- End of row -->

  <!-- Real-time Chart Section -->
  <div class="row">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">Network Traffic (Real-time)</div>
        <div class="card-body">
          <canvas id="networkTrafficChart"></canvas>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
  <script>
    document.addEventListener('DOMContentLoaded', (event) => {
      const ctx = document.getElementById('networkTrafficChart').getContext('2d');
      const networkTrafficChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [], // Initialize with empty labels
          datasets: [{
            label: 'Packet Flow Rate',
            data: [], // Initialize with empty data
            borderColor: 'rgb(25, 25, 112)',
            backgroundColor: '#ADD8E6',
            fill: true,
            tension: 0.6
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              title: {
                display: true,
                text: 'Time'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Packet Flow Rate'
              },
              min: 0,
              max: 100000
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'top'
            }
          }
        }
      });

      // WebSocket connection
      const flowSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/flow_data/'
      );

      flowSocket.onopen = function(e) {
        console.log('WebSocket connection established');
      };

      flowSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        data = data["data"];
        console.log(data);
        const timestamp = data.timestamp;
        const flowRate = data.flow_byts_s;
        console.log(timestamp, flowRate);

        // Update chart data
        networkTrafficChart.data.labels.push(timestamp);
        networkTrafficChart.data.datasets[0].data.push(flowRate);

        // Limit the number of data points shown
        const maxDataPoints = 50;
        if (networkTrafficChart.data.labels.length > maxDataPoints) {
          networkTrafficChart.data.labels.shift(); // Remove oldest label
          networkTrafficChart.data.datasets[0].data.shift(); // Remove oldest data point
        }

        // Update the chart
        networkTrafficChart.update();
      };

      flowSocket.onclose = function(e) {
        console.error('WebSocket closed unexpectedly');
      };
    });
  </script>
{% endblock %}
