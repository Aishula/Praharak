{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
  <link href="{% static 'main.css' %}" rel="stylesheet">
  <style>
    .card {
      margin-bottom: 20px;
    }
    .siem-title {
      text-align: center;
      margin-bottom: 40px;
      padding: 20px;
      color: #343a40;
      font-size: 2rem;
      border-bottom-color: antiquewhite;
      border-bottom-style: dashed;
}
  </style>
{% endblock %}

{% block page_title %}
<h1 class="siem-title">Dashboard</h1>
{% endblock %}


{% block content %}
  <div class="row">
    <!-- Table Section -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">Log Sources</div>
        <div class="card-body">
          <table class="table table-striped" id="logTable">
            <thead>
              <tr>
                <th>Source</th>
                <th>Destination</th>
                <th>Protocol</th>
                <th>Remarks</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>172.16.8.1</td>
                <td>192.168.1.1</td>
                <td>TCP</td>
                <td>Normal</td>
              </tr>
              <tr>
                <td>128.2.12.0</td>
                <td>192.168.1.2</td>
                <td>UDP</td>
                <td>Suspicious</td>
              </tr>
              <tr>
                <td>192.168.1.34</td>
                <td>192.168.1.3</td>
                <td>TCP</td>
                <td>Normal</td>
              </tr>
              <tr>
                <td>172.16.5.1</td>
                <td>192.168.1.4</td>
                <td>UDP</td>
                <td>Critical</td>
              </tr>
              <tr>
                <td>172.16.5.10</td>
                <td>192.168.1.5</td>
                <td>TCP</td>
                <td>Normal</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Bar Chart Section -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">Attack vs Normal Data</div>
        <div class="card-body">
          <canvas id="attackNormalChart"></canvas>
        </div>
      </div>
    </div>
  </div> <!-- End of row -->

  <!-- Real-time Chart Section -->
  <div class="row">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">Network Traffic (Real-time)</div>
        <div class="card-body">
          <canvas id="networkTrafficChart"></canvas>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
  <script>
    document.addEventListener('DOMContentLoaded', (event) => {

      // Initialize counters
      let attackCount = 0;
      let normalCount = 0;

      // Initialize index for circular buffer
      let index = 0;
      let remarks = "Normal";
      let protocol = "TCP";

      // Initialize the chart
      const attackNormalCtx = document.getElementById('attackNormalChart').getContext('2d');
      const attackNormalChart = new Chart(attackNormalCtx, {
        type: 'bar', // Bar chart to display the counts
        data: {
          labels: ['Attack Traffic', 'Normal Traffic'], // Labels for the bars
          datasets: [
            {
              label: 'Traffic Count',
              data: [attackCount, normalCount], // Initial counts
              backgroundColor: ['red', 'blue'], // Colors for the bars
            }
          ]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Count'
              }
            }
          }
        }
      });

      const networkTrafficCtx = document.getElementById('networkTrafficChart').getContext('2d');
      const networkTrafficChart = new Chart(networkTrafficCtx, {
        type: 'line',
        data: {
          labels: [], // Initialize with empty labels
          datasets: [{
            label: 'Packet Flow Rate',
            data: [], // Initialize with empty data
            borderColor: 'rgb(230,0,246)',
            backgroundColor: '#eeecec',
            fill: false,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              title: {
                display: true,
                text: 'Time'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Packet Flow Rate'
              },
              min: 0,
              max: 1000000
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'top'
            }
          }
        }
      });

      // WebSocket connection
      const flowSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/flow_data/'
      );

      flowSocket.onopen = function(e) {
        console.log('WebSocket connection established');
      };

      flowSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        data = data["data"];
        console.log(data);
        const timestamp = data.timestamp;
        const flowRate = data.flow_bytes_s;
        const prediction = data.prediction;

        // Update counters based on prediction
        if (prediction === "1") {
          attackCount++;
          remarks = "Malicious";
        } else if (prediction === "0") {
          normalCount++;
          remarks = "Normal";
        }
        // Update chart data
        attackNormalChart.data.datasets[0].data = [attackCount, normalCount];

        // Update the chart
        attackNormalChart.update();

        // Update chart data
        networkTrafficChart.data.labels.push(timestamp);
        networkTrafficChart.data.datasets[0].data.push(flowRate);

        // Limit the number of data points shown
        const maxDataPoints = 50;
        if (networkTrafficChart.data.labels.length > maxDataPoints) {
          networkTrafficChart.data.labels.shift(); // Remove oldest label
          networkTrafficChart.data.datasets[0].data.shift(); // Remove oldest data point
        }

        // Update the chart
        networkTrafficChart.update();

        if (data.protocol === 6) {
          protocol = "TCP";
        } else if (data.protocol === 17) {
          protocol = "UDP";
        }

        // Update existing table rows using circular buffer logic
        const tableBody = document.getElementById('logTable').getElementsByTagName('tbody')[0];
        const rows = tableBody.getElementsByTagName('tr');
        const cells = rows[index].getElementsByTagName('td');

        cells[0].innerText = data.src_ip;
        cells[1].innerText = data.dst_ip;
        cells[2].innerText = protocol;
        cells[3].innerText = remarks;

        // Increment index for circular buffer
        index = (index + 1) % rows.length;
      };

      flowSocket.onclose = function(e) {
        console.error('WebSocket closed unexpectedly');
      };
    });
  </script>
{% endblock %}
